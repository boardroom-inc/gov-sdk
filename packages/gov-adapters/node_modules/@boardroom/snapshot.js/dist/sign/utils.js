!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@ethersproject/wallet"),require("@ethersproject/hash"),require("@ethersproject/bytes"),require("@ethersproject/providers"),require("cross-fetch"),require("@ethersproject/abi"),require("@ethersproject/contracts"),require("@ethersproject/address"),require("@ethersproject/units"),require("json-to-graphql-query"),require("ajv"),require("ajv-formats"),require("lodash.set")):"function"==typeof define&&define.amd?define(["exports","@ethersproject/wallet","@ethersproject/hash","@ethersproject/bytes","@ethersproject/providers","cross-fetch","@ethersproject/abi","@ethersproject/contracts","@ethersproject/address","@ethersproject/units","json-to-graphql-query","ajv","ajv-formats","lodash.set"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).snapshot={},t.wallet,t.hash,t.bytes,t.providers$1,null,null,t.contracts,t.address,t.units,null,t.Ajv,t.addFormats)}(this,(function(t,e,r,n,o,i,u,c,s,a,l,f,h){"use strict";function p(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var d=p(f),v=p(h);
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
function y(t,e,r,n){return new(r||(r=Promise))((function(o,i){function u(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(u,c)}s((n=n.apply(t,e||[])).next())}))}function g(t,e){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=e.call(t,u)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function b(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),u=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)u.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return u}function m(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(b(arguments[e]));return t}var V={};(function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"number"==typeof t&&void 0!==(null==e?void 0:e[t-1])},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){return this.proposal.choices[this.selected-1]}})(),function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.selected?this.proposal.choices.filter((function(e,r){return t.selected.includes(r+1)})).join(", "):""}}();function j(t,e){var r=t/e.reduce((function(t,e){return t+e}),0);return isNaN(r)?0:r}function S(t,e){return Math.sqrt(t*e)}function w(t){return t*t}function C(t,e){return t.map((function(t){return e*t}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this.getValidVotes(),e=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),r=this.proposal.choices.map((function(e,r){return w(t.map((function(t){return S(j(t.choice[r+1],Object.values(t.choice)),t.balance)})).reduce((function(t,e){return t+e}),0))}));return C(r.map((function(t,e){return j(r[e],r)})),e)},t.prototype.getScoresByStrategy=function(){var t=this,e=this.getValidVotes(),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),n=this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.map((function(t){return S(j(t.choice[n+1],Object.values(t.choice)),t.scores[r])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[w(t)]}))}));return n.map((function(e,o){return C(t.strategies.map((function(t,e){return j(n[o][e][0],n.flat(2))})),r)}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1]){var n=j(t.selected[r+1],Object.values(t.selected));return Math.round(1e3*n)/10+"% for "+e}})).filter((function(t){return null!=t})).join(", ")}}();function q(t,e){var r=m(new Set(t.map((function(t){return t[0]})).flat())),n=Object.entries(t.reduce((function(t,e,r,n){var o=b(e,1)[0],i=n[r][1];t[o[0]][0]+=i;var u=n[r][2];return u.length>1?t[o[0]][1]=u.map((function(e,r){return e+t[o[0]][1][r]||e})):t[o[0]][1]=[t[o[0]][1].concat(u).reduce((function(t,e){return t+e}),0)],t}),Object.assign.apply(Object,m([{}],r.map((function(t){var e;return(e={})[t]=[0,[]],e})))))),o=n.map((function(t){return[t[0],t[1][0]]})),i=b(o.reduce((function(t,e){var r=b(t,2),n=r[0],o=r[1],i=b(e,2),u=i[0],c=i[1];return c>o?[u,c]:[n,o]}),["?",-1/0]),2),u=(i[0],i[1]),c=b(o.reduce((function(t,e){var r=b(t,2),n=r[0],o=r[1],i=b(e,2),u=i[0],c=i[1];return c<o?[u,c]:[n,o]}),["?",1/0]),2),s=c[0],a=(c[1],n.sort((function(t,e){return e[1][0]-t[1][0]}))),l=t.map((function(t){return t[1]})).reduce((function(t,e){return t+e}),0);return e.push({round:e.length+1,sortedByHighest:a}),u>l/2||a.length<3?e:q(t.map((function(t){return[t[0].filter((function(t){return t!=s})),t[1],t[2]]})).filter((function(t){return t[0].length>0})),e)}function O(t){var e=q(t.map((function(t){return[t.choice,t.balance,t.scores]})),[]);return e[e.length-1].sortedByHighest}function x(t,e){var r=O(t);return e.choices.map((function(t,e){return r.filter((function(t){return Number(t[0])===e+1})).reduce((function(t,e){return t+e[1][0]}),0)}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size&&t.length>0&&t.length===e.length},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){return x(this.getValidVotes(),this.proposal)},t.prototype.getScoresByStrategy=function(){var t=this,e=O(this.getValidVotes());return this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.filter((function(t){return Number(t[0])===n+1})).reduce((function(t,e){return t+e[1][1][r]}),0)}))}))},t.prototype.getScoresTotal=function(){return x(this.votes,this.proposal).reduce((function(t,e){return t+e}))},t.prototype.getChoiceString=function(){var t=this;return this.selected.map((function(e){if(t.proposal.choices[e-1])return t.proposal.choices[e-1]})).map((function(t,e){return"("+((r=e+1)+((n=["th","st","nd","rd"])[((o=r%100)-20)%10]||n[o]||n[0])+") ")+t;var r,n,o})).join(", ")}}();function T(t,e,r){var n=r.reduce((function(t,e){return t+e}),0),o=e[t]/n*100;return isNaN(o)?0:o}function A(t,e,r){return T(t+1,e,Object.values(e))/100*r}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.getValidVotes().map((function(t){return A(r,t.choice,t.balance)})).reduce((function(t,e){return t+e}),0)})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(t,r){return T(r,e,e)})).map((function(t){return r/100*t}))},t.prototype.getScoresByStrategy=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().map((function(t){return A(r,t.choice,t.scores[n])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[t]}))})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(n,o){return t.strategies.map((function(t,r){return T(0,e[o][r],e.flat(2))})).map((function(t){return[r/100*t]})).flat()}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1])return Math.round(10*T(r+1,t.selected,Object.values(t.selected)))/10+"% for "+e})).filter((function(t){return null!=t})).join(", ")}}();var N=new d.default({allErrors:!0,allowUnionTypes:!0,$data:!0});function _(t,e,r,n){return y(this,void 0,void 0,(function(){var o,i,u;return g(this,(function(s){switch(s.label){case 0:o=new c.Contract(r[0],e,t),s.label=1;case 1:return s.trys.push([1,3,,4]),i=r[2]||[],[4,o[r[1]].apply(o,m(i,[n||{}]))];case 2:return[2,s.sent()];case 3:return u=s.sent(),[2,Promise.reject(u)];case 4:return[2]}}))}))}function k(t,e,r,o){return y(this,void 0,void 0,(function(){var i,u,c,s;return g(this,(function(a){switch(a.label){case 0:u="0x1626ba7e",c="function isValidSignature(bytes32 _hash, bytes memory _signature) public view returns (bytes4 magicValue)",a.label=1;case 1:return a.trys.push([1,3,,4]),[4,_(o,[c],[t,"isValidSignature",[n.arrayify(r),e]])];case 2:return i=a.sent(),[3,4];case 3:if((s=a.sent()).message.startsWith("missing revert data in call exception"))return[2,!1];throw s;case 4:return[2,i.toLowerCase()===u.toLowerCase()]}}))}))}function B(t,e,r,o){return y(this,void 0,void 0,(function(){var i;return g(this,(function(u){switch(u.label){case 0:return i="0x20c13b0b","function isValidSignature(bytes _hash, bytes memory _signature) public view returns (bytes4 magicValue)",[4,_(o,["function isValidSignature(bytes _hash, bytes memory _signature) public view returns (bytes4 magicValue)"],[t,"isValidSignature",[n.arrayify(r),e]])];case 1:return[2,u.sent().toLowerCase()===i.toLowerCase()]}}))}))}function W(t,e,r,n){return void 0===n&&(n="1"),y(this,void 0,void 0,(function(){var i;return g(this,(function(u){switch(u.label){case 0:return i=function(t){var e="https://rpc.snapshot.org/"+t;return V[t]||(V[t]=new o.StaticJsonRpcProvider({url:e,timeout:25e3,allowGzip:!0},Number(t))),V[t]}(n),[4,k(t,e,r,i)];case 1:return u.sent()?[2,!0]:[4,B(t,e,r,i)];case 2:return[2,u.sent()]}}))}))}function F(t){var e=t.domain,n=t.types,o=t.message;return r._TypedDataEncoder.hash(e,n,o)}v.default(N),N.addFormat("address",{validate:function(t){try{return s.isAddress(t)}catch(t){return!1}}}),N.addFormat("long",{validate:function(){return!0}}),N.addFormat("ethValue",{validate:function(t){if(!t.match(/^([0-9]|[1-9][0-9]+)(\.[0-9]+)?$/))return!1;try{return a.parseUnits(t,18),!0}catch(t){return!1}}}),N.addFormat("customUrl",{type:"string",validate:function(t){return!t.length||(t.startsWith("http://")||t.startsWith("https://")||t.startsWith("ipfs://")||t.startsWith("ipns://")||t.startsWith("snapshot://"))}}),t.getHash=F,t.verify=function(t,r,n,o){return void 0===o&&(o="1"),y(this,void 0,void 0,(function(){var i,u,c,s,a;return g(this,(function(l){switch(l.label){case 0:i=n.domain,u=n.types,c=n.message,s=F(n);try{if(a=e.verifyTypedData(i,u,c,r),t===a)return[2,!0]}catch(t){}return[4,W(t,r,s,o)];case 1:return[2,l.sent()]}}))}))},Object.defineProperty(t,"__esModule",{value:!0})}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@ethersproject/bytes"),require("@ethersproject/providers"),require("cross-fetch"),require("@ethersproject/abi"),require("@ethersproject/contracts"),require("@ethersproject/address"),require("@ethersproject/units"),require("@ethersproject/hash"),require("json-to-graphql-query"),require("ajv"),require("ajv-formats"),require("lodash.set"),require("@ethersproject/wallet")):"function"==typeof define&&define.amd?define(["exports","@ethersproject/bytes","@ethersproject/providers","cross-fetch","@ethersproject/abi","@ethersproject/contracts","@ethersproject/address","@ethersproject/units","@ethersproject/hash","json-to-graphql-query","ajv","ajv-formats","lodash.set","@ethersproject/wallet"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).snapshot={},t.bytes,t.providers$1,null,null,t.contracts,t.address,t.units,null,null,t.Ajv,t.addFormats)}(this,(function(t,e,r,n,o,i,u,c,s,a,l,f){"use strict";function h(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var p=h(l),d=h(f);
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
function v(t,e,r,n){return new(r||(r=Promise))((function(o,i){function u(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(u,c)}s((n=n.apply(t,e||[])).next())}))}function y(t,e){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=e.call(t,u)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function g(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),u=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)u.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return u}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(g(arguments[e]));return t}var m={};(function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"number"==typeof t&&void 0!==(null==e?void 0:e[t-1])},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){return this.proposal.choices[this.selected-1]}})(),function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.selected?this.proposal.choices.filter((function(e,r){return t.selected.includes(r+1)})).join(", "):""}}();function V(t,e){var r=t/e.reduce((function(t,e){return t+e}),0);return isNaN(r)?0:r}function j(t,e){return Math.sqrt(t*e)}function S(t){return t*t}function w(t,e){return t.map((function(t){return e*t}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this.getValidVotes(),e=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),r=this.proposal.choices.map((function(e,r){return S(t.map((function(t){return j(V(t.choice[r+1],Object.values(t.choice)),t.balance)})).reduce((function(t,e){return t+e}),0))}));return w(r.map((function(t,e){return V(r[e],r)})),e)},t.prototype.getScoresByStrategy=function(){var t=this,e=this.getValidVotes(),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),n=this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.map((function(t){return j(V(t.choice[n+1],Object.values(t.choice)),t.scores[r])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[S(t)]}))}));return n.map((function(e,o){return w(t.strategies.map((function(t,e){return V(n[o][e][0],n.flat(2))})),r)}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1]){var n=V(t.selected[r+1],Object.values(t.selected));return Math.round(1e3*n)/10+"% for "+e}})).filter((function(t){return null!=t})).join(", ")}}();function C(t,e){var r=b(new Set(t.map((function(t){return t[0]})).flat())),n=Object.entries(t.reduce((function(t,e,r,n){var o=g(e,1)[0],i=n[r][1];t[o[0]][0]+=i;var u=n[r][2];return u.length>1?t[o[0]][1]=u.map((function(e,r){return e+t[o[0]][1][r]||e})):t[o[0]][1]=[t[o[0]][1].concat(u).reduce((function(t,e){return t+e}),0)],t}),Object.assign.apply(Object,b([{}],r.map((function(t){var e;return(e={})[t]=[0,[]],e})))))),o=n.map((function(t){return[t[0],t[1][0]]})),i=g(o.reduce((function(t,e){var r=g(t,2),n=r[0],o=r[1],i=g(e,2),u=i[0],c=i[1];return c>o?[u,c]:[n,o]}),["?",-1/0]),2),u=(i[0],i[1]),c=g(o.reduce((function(t,e){var r=g(t,2),n=r[0],o=r[1],i=g(e,2),u=i[0],c=i[1];return c<o?[u,c]:[n,o]}),["?",1/0]),2),s=c[0],a=(c[1],n.sort((function(t,e){return e[1][0]-t[1][0]}))),l=t.map((function(t){return t[1]})).reduce((function(t,e){return t+e}),0);return e.push({round:e.length+1,sortedByHighest:a}),u>l/2||a.length<3?e:C(t.map((function(t){return[t[0].filter((function(t){return t!=s})),t[1],t[2]]})).filter((function(t){return t[0].length>0})),e)}function q(t){var e=C(t.map((function(t){return[t.choice,t.balance,t.scores]})),[]);return e[e.length-1].sortedByHighest}function O(t,e){var r=q(t);return e.choices.map((function(t,e){return r.filter((function(t){return Number(t[0])===e+1})).reduce((function(t,e){return t+e[1][0]}),0)}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size&&t.length>0&&t.length===e.length},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){return O(this.getValidVotes(),this.proposal)},t.prototype.getScoresByStrategy=function(){var t=this,e=q(this.getValidVotes());return this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.filter((function(t){return Number(t[0])===n+1})).reduce((function(t,e){return t+e[1][1][r]}),0)}))}))},t.prototype.getScoresTotal=function(){return O(this.votes,this.proposal).reduce((function(t,e){return t+e}))},t.prototype.getChoiceString=function(){var t=this;return this.selected.map((function(e){if(t.proposal.choices[e-1])return t.proposal.choices[e-1]})).map((function(t,e){return"("+((r=e+1)+((n=["th","st","nd","rd"])[((o=r%100)-20)%10]||n[o]||n[0])+") ")+t;var r,n,o})).join(", ")}}();function x(t,e,r){var n=r.reduce((function(t,e){return t+e}),0),o=e[t]/n*100;return isNaN(o)?0:o}function A(t,e,r){return x(t+1,e,Object.values(e))/100*r}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.getValidVotes().map((function(t){return A(r,t.choice,t.balance)})).reduce((function(t,e){return t+e}),0)})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(t,r){return x(r,e,e)})).map((function(t){return r/100*t}))},t.prototype.getScoresByStrategy=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().map((function(t){return A(r,t.choice,t.scores[n])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[t]}))})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(n,o){return t.strategies.map((function(t,r){return x(0,e[o][r],e.flat(2))})).map((function(t){return[r/100*t]})).flat()}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1])return Math.round(10*x(r+1,t.selected,Object.values(t.selected)))/10+"% for "+e})).filter((function(t){return null!=t})).join(", ")}}();var N=new p.default({allErrors:!0,allowUnionTypes:!0,$data:!0});function T(t,e,r,n){return v(this,void 0,void 0,(function(){var o,u,c;return y(this,(function(s){switch(s.label){case 0:o=new i.Contract(r[0],e,t),s.label=1;case 1:return s.trys.push([1,3,,4]),u=r[2]||[],[4,o[r[1]].apply(o,b(u,[n||{}]))];case 2:return[2,s.sent()];case 3:return c=s.sent(),[2,Promise.reject(c)];case 4:return[2]}}))}))}function k(t,r,n,o){return v(this,void 0,void 0,(function(){var i,u,c,s;return y(this,(function(a){switch(a.label){case 0:u="0x1626ba7e",c="function isValidSignature(bytes32 _hash, bytes memory _signature) public view returns (bytes4 magicValue)",a.label=1;case 1:return a.trys.push([1,3,,4]),[4,T(o,[c],[t,"isValidSignature",[e.arrayify(n),r]])];case 2:return i=a.sent(),[3,4];case 3:if((s=a.sent()).message.startsWith("missing revert data in call exception"))return[2,!1];throw s;case 4:return[2,i.toLowerCase()===u.toLowerCase()]}}))}))}function _(t,r,n,o){return v(this,void 0,void 0,(function(){var i;return y(this,(function(u){switch(u.label){case 0:return i="0x20c13b0b","function isValidSignature(bytes _hash, bytes memory _signature) public view returns (bytes4 magicValue)",[4,T(o,["function isValidSignature(bytes _hash, bytes memory _signature) public view returns (bytes4 magicValue)"],[t,"isValidSignature",[e.arrayify(n),r]])];case 1:return[2,u.sent().toLowerCase()===i.toLowerCase()]}}))}))}d.default(N),N.addFormat("address",{validate:function(t){try{return u.isAddress(t)}catch(t){return!1}}}),N.addFormat("long",{validate:function(){return!0}}),N.addFormat("ethValue",{validate:function(t){if(!t.match(/^([0-9]|[1-9][0-9]+)(\.[0-9]+)?$/))return!1;try{return c.parseUnits(t,18),!0}catch(t){return!1}}}),N.addFormat("customUrl",{type:"string",validate:function(t){return!t.length||(t.startsWith("http://")||t.startsWith("https://")||t.startsWith("ipfs://")||t.startsWith("ipns://")||t.startsWith("snapshot://"))}}),t.verify=function(t,e,n,o){return void 0===o&&(o="1"),v(this,void 0,void 0,(function(){var i;return y(this,(function(u){switch(u.label){case 0:return i=function(t){var e="https://rpc.snapshot.org/"+t;return m[t]||(m[t]=new r.StaticJsonRpcProvider({url:e,timeout:25e3,allowGzip:!0},Number(t))),m[t]}(o),[4,k(t,e,n,i)];case 1:return u.sent()?[2,!0]:[4,_(t,e,n,i)];case 2:return[2,u.sent()]}}))}))},t.verifyDefault=k,t.verifyOldVersion=_,Object.defineProperty(t,"__esModule",{value:!0})}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("cross-fetch"),require("@ethersproject/abi"),require("@ethersproject/contracts"),require("@ethersproject/address"),require("@ethersproject/units"),require("@ethersproject/hash"),require("json-to-graphql-query"),require("ajv"),require("ajv-formats"),require("lodash.set"),require("@ethersproject/providers"),require("@ethersproject/bytes"),require("@ethersproject/wallet")):"function"==typeof define&&define.amd?define(["cross-fetch","@ethersproject/abi","@ethersproject/contracts","@ethersproject/address","@ethersproject/units","@ethersproject/hash","json-to-graphql-query","ajv","ajv-formats","lodash.set","@ethersproject/providers","@ethersproject/bytes","@ethersproject/wallet"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).snapshot=e(null,null,null,t.address,t.units,null,null,t.Ajv,t.addFormats)}(this,(function(t,e,r,n,o,i,u,c,s){"use strict";function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var f=a(c),l=a(s);
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
function p(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),u=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)u.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return u}function h(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t}(function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"number"==typeof t&&void 0!==(null==e?void 0:e[t-1])},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){return this.proposal.choices[this.selected-1]}})(),function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.selected?this.proposal.choices.filter((function(e,r){return t.selected.includes(r+1)})).join(", "):""}}();function d(t,e){var r=t/e.reduce((function(t,e){return t+e}),0);return isNaN(r)?0:r}function v(t,e){return Math.sqrt(t*e)}function g(t){return t*t}function y(t,e){return t.map((function(t){return e*t}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this.getValidVotes(),e=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),r=this.proposal.choices.map((function(e,r){return g(t.map((function(t){return v(d(t.choice[r+1],Object.values(t.choice)),t.balance)})).reduce((function(t,e){return t+e}),0))}));return y(r.map((function(t,e){return d(r[e],r)})),e)},t.prototype.getScoresByStrategy=function(){var t=this,e=this.getValidVotes(),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),n=this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.map((function(t){return v(d(t.choice[n+1],Object.values(t.choice)),t.scores[r])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[g(t)]}))}));return n.map((function(e,o){return y(t.strategies.map((function(t,e){return d(n[o][e][0],n.flat(2))})),r)}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1]){var n=d(t.selected[r+1],Object.values(t.selected));return Math.round(1e3*n)/10+"% for "+e}})).filter((function(t){return null!=t})).join(", ")}}();function m(t,e,r){var n=r.reduce((function(t,e){return t+e}),0),o=e[t]/n*100;return isNaN(o)?0:o}function b(t,e,r){return m(t+1,e,Object.values(e))/100*r}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.getValidVotes().map((function(t){return b(r,t.choice,t.balance)})).reduce((function(t,e){return t+e}),0)})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(t,r){return m(r,e,e)})).map((function(t){return r/100*t}))},t.prototype.getScoresByStrategy=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().map((function(t){return b(r,t.choice,t.scores[n])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[t]}))})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(n,o){return t.strategies.map((function(t,r){return m(0,e[o][r],e.flat(2))})).map((function(t){return[r/100*t]})).flat()}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1])return Math.round(10*m(r+1,t.selected,Object.values(t.selected)))/10+"% for "+e})).filter((function(t){return null!=t})).join(", ")}}();var V=new f.default({allErrors:!0,allowUnionTypes:!0,$data:!0});function j(t,e){var r=h(new Set(t.map((function(t){return t[0]})).flat())),n=Object.entries(t.reduce((function(t,e,r,n){var o=p(e,1)[0],i=n[r][1];t[o[0]][0]+=i;var u=n[r][2];return u.length>1?t[o[0]][1]=u.map((function(e,r){return e+t[o[0]][1][r]||e})):t[o[0]][1]=[t[o[0]][1].concat(u).reduce((function(t,e){return t+e}),0)],t}),Object.assign.apply(Object,h([{}],r.map((function(t){var e;return(e={})[t]=[0,[]],e})))))),o=n.map((function(t){return[t[0],t[1][0]]})),i=p(o.reduce((function(t,e){var r=p(t,2),n=r[0],o=r[1],i=p(e,2),u=i[0],c=i[1];return c>o?[u,c]:[n,o]}),["?",-1/0]),2),u=(i[0],i[1]),c=p(o.reduce((function(t,e){var r=p(t,2),n=r[0],o=r[1],i=p(e,2),u=i[0],c=i[1];return c<o?[u,c]:[n,o]}),["?",1/0]),2),s=c[0],a=(c[1],n.sort((function(t,e){return e[1][0]-t[1][0]}))),f=t.map((function(t){return t[1]})).reduce((function(t,e){return t+e}),0);return e.push({round:e.length+1,sortedByHighest:a}),u>f/2||a.length<3?e:j(t.map((function(t){return[t[0].filter((function(t){return t!=s})),t[1],t[2]]})).filter((function(t){return t[0].length>0})),e)}function S(t){var e=j(t.map((function(t){return[t.choice,t.balance,t.scores]})),[]);return e[e.length-1].sortedByHighest}function q(t,e){var r=S(t);return e.choices.map((function(t,e){return r.filter((function(t){return Number(t[0])===e+1})).reduce((function(t,e){return t+e[1][0]}),0)}))}return l.default(V),V.addFormat("address",{validate:function(t){try{return n.isAddress(t)}catch(t){return!1}}}),V.addFormat("long",{validate:function(){return!0}}),V.addFormat("ethValue",{validate:function(t){if(!t.match(/^([0-9]|[1-9][0-9]+)(\.[0-9]+)?$/))return!1;try{return o.parseUnits(t,18),!0}catch(t){return!1}}}),V.addFormat("customUrl",{type:"string",validate:function(t){return!t.length||(t.startsWith("http://")||t.startsWith("https://")||t.startsWith("ipfs://")||t.startsWith("ipns://")||t.startsWith("snapshot://"))}}),function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}return t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size&&t.length>0&&t.length===e.length},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){return q(this.getValidVotes(),this.proposal)},t.prototype.getScoresByStrategy=function(){var t=this,e=S(this.getValidVotes());return this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.filter((function(t){return Number(t[0])===n+1})).reduce((function(t,e){return t+e[1][1][r]}),0)}))}))},t.prototype.getScoresTotal=function(){return q(this.votes,this.proposal).reduce((function(t,e){return t+e}))},t.prototype.getChoiceString=function(){var t=this;return this.selected.map((function(e){if(t.proposal.choices[e-1])return t.proposal.choices[e-1]})).map((function(t,e){return"("+((r=e+1)+((n=["th","st","nd","rd"])[((o=r%100)-20)%10]||n[o]||n[0])+") ")+t;var r,n,o})).join(", ")},t}()}));

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("cross-fetch"),require("@ethersproject/abi"),require("@ethersproject/contracts"),require("@ethersproject/address"),require("@ethersproject/units"),require("@ethersproject/hash"),require("json-to-graphql-query"),require("ajv"),require("ajv-formats"),require("lodash.set"),require("@ethersproject/providers"),require("@ethersproject/bytes"),require("@ethersproject/wallet")):"function"==typeof define&&define.amd?define(["exports","cross-fetch","@ethersproject/abi","@ethersproject/contracts","@ethersproject/address","@ethersproject/units","@ethersproject/hash","json-to-graphql-query","ajv","ajv-formats","lodash.set","@ethersproject/providers","@ethersproject/bytes","@ethersproject/wallet"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).snapshot={},t.fetch,null,null,t.address,t.units,null,t.jsonToGraphqlQuery,t.Ajv,t.addFormats)}(this,(function(t,e,r,n,o,i,u,c,s,a){"use strict";function f(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var l=f(e),p=f(s),h=f(a),d=function(){return d=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},d.apply(this,arguments)};function y(t,e,r,n){return new(r||(r=Promise))((function(o,i){function u(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(u,c)}s((n=n.apply(t,e||[])).next())}))}function v(t,e){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=e.call(t,u)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function g(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,o,i=r.call(t),u=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)u.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return u}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(g(arguments[e]));return t}(function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"number"==typeof t&&void 0!==(null==e?void 0:e[t-1])},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice===r+1})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){return this.proposal.choices[this.selected-1]}})(),function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.balance}),0)}))},t.prototype.getScoresByStrategy=function(){var t=this;return this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().filter((function(t){return t.choice.includes(r+1)})).reduce((function(t,e){return t+e.scores[n]}),0)}))}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.selected?this.proposal.choices.filter((function(e,r){return t.selected.includes(r+1)})).join(", "):""}}();function m(t,e){var r=t/e.reduce((function(t,e){return t+e}),0);return isNaN(r)?0:r}function j(t,e){return Math.sqrt(t*e)}function V(t){return t*t}function S(t,e){return t.map((function(t){return e*t}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this.getValidVotes(),e=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),r=this.proposal.choices.map((function(e,r){return V(t.map((function(t){return j(m(t.choice[r+1],Object.values(t.choice)),t.balance)})).reduce((function(t,e){return t+e}),0))}));return S(r.map((function(t,e){return m(r[e],r)})),e)},t.prototype.getScoresByStrategy=function(){var t=this,e=this.getValidVotes(),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0),n=this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.map((function(t){return j(m(t.choice[n+1],Object.values(t.choice)),t.scores[r])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[V(t)]}))}));return n.map((function(e,o){return S(t.strategies.map((function(t,e){return m(n[o][e][0],n.flat(2))})),r)}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1]){var n=m(t.selected[r+1],Object.values(t.selected));return Math.round(1e3*n)/10+"% for "+e}})).filter((function(t){return null!=t})).join(", ")}}();function w(t,e){var r=b(new Set(t.map((function(t){return t[0]})).flat())),n=Object.entries(t.reduce((function(t,e,r,n){var o=g(e,1)[0],i=n[r][1];t[o[0]][0]+=i;var u=n[r][2];return u.length>1?t[o[0]][1]=u.map((function(e,r){return e+t[o[0]][1][r]||e})):t[o[0]][1]=[t[o[0]][1].concat(u).reduce((function(t,e){return t+e}),0)],t}),Object.assign.apply(Object,b([{}],r.map((function(t){var e;return(e={})[t]=[0,[]],e})))))),o=n.map((function(t){return[t[0],t[1][0]]})),i=g(o.reduce((function(t,e){var r=g(t,2),n=r[0],o=r[1],i=g(e,2),u=i[0],c=i[1];return c>o?[u,c]:[n,o]}),["?",-1/0]),2),u=(i[0],i[1]),c=g(o.reduce((function(t,e){var r=g(t,2),n=r[0],o=r[1],i=g(e,2),u=i[0],c=i[1];return c<o?[u,c]:[n,o]}),["?",1/0]),2),s=c[0],a=(c[1],n.sort((function(t,e){return e[1][0]-t[1][0]}))),f=t.map((function(t){return t[1]})).reduce((function(t,e){return t+e}),0);return e.push({round:e.length+1,sortedByHighest:a}),u>f/2||a.length<3?e:w(t.map((function(t){return[t[0].filter((function(t){return t!=s})),t[1],t[2]]})).filter((function(t){return t[0].length>0})),e)}function O(t){var e=w(t.map((function(t){return[t.choice,t.balance,t.scores]})),[]);return e[e.length-1].sortedByHighest}function q(t,e){var r=O(t);return e.choices.map((function(t,e){return r.filter((function(t){return Number(t[0])===e+1})).reduce((function(t,e){return t+e[1][0]}),0)}))}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return Array.isArray(t)&&t.every((function(t){return void 0!==(null==e?void 0:e[t-1])}))&&t.length===new Set(t).size&&t.length>0&&t.length===e.length},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){return q(this.getValidVotes(),this.proposal)},t.prototype.getScoresByStrategy=function(){var t=this,e=O(this.getValidVotes());return this.proposal.choices.map((function(r,n){return t.strategies.map((function(t,r){return e.filter((function(t){return Number(t[0])===n+1})).reduce((function(t,e){return t+e[1][1][r]}),0)}))}))},t.prototype.getScoresTotal=function(){return q(this.votes,this.proposal).reduce((function(t,e){return t+e}))},t.prototype.getChoiceString=function(){var t=this;return this.selected.map((function(e){if(t.proposal.choices[e-1])return t.proposal.choices[e-1]})).map((function(t,e){return"("+((r=e+1)+((n=["th","st","nd","rd"])[((o=r%100)-20)%10]||n[o]||n[0])+") ")+t;var r,n,o})).join(", ")}}();function k(t,e,r){var n=r.reduce((function(t,e){return t+e}),0),o=e[t]/n*100;return isNaN(o)?0:o}function C(t,e,r){return k(t+1,e,Object.values(e))/100*r}!function(){function t(t,e,r,n){this.proposal=t,this.votes=e,this.strategies=r,this.selected=n}t.isValidChoice=function(t,e){return"object"==typeof t&&!Array.isArray(t)&&null!==t&&Object.keys(t).every((function(t){return void 0!==(null==e?void 0:e[Number(t)-1])}))&&Object.keys(t).length>0&&Object.values(t).every((function(t){return"number"==typeof t&&t>=0}))&&Object.values(t).some((function(t){return"number"==typeof t&&t>0}))},t.prototype.getValidVotes=function(){var e=this;return this.votes.filter((function(r){return t.isValidChoice(r.choice,e.proposal.choices)}))},t.prototype.getScores=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.getValidVotes().map((function(t){return C(r,t.choice,t.balance)})).reduce((function(t,e){return t+e}),0)})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(t,r){return k(r,e,e)})).map((function(t){return r/100*t}))},t.prototype.getScoresByStrategy=function(){var t=this,e=this.proposal.choices.map((function(e,r){return t.strategies.map((function(e,n){return t.getValidVotes().map((function(t){return C(r,t.choice,t.scores[n])})).reduce((function(t,e){return t+e}),0)}))})).map((function(t){return t.map((function(t){return[t]}))})),r=this.getValidVotes().reduce((function(t,e){return t+e.balance}),0);return e.map((function(n,o){return t.strategies.map((function(t,r){return k(0,e[o][r],e.flat(2))})).map((function(t){return[r/100*t]})).flat()}))},t.prototype.getScoresTotal=function(){return this.votes.reduce((function(t,e){return t+e.balance}),0)},t.prototype.getChoiceString=function(){var t=this;return this.proposal.choices.map((function(e,r){if(t.selected[r+1])return Math.round(10*k(r+1,t.selected,Object.values(t.selected)))/10+"% for "+e})).filter((function(t){return null!=t})).join(", ")}}();var T=new p.default({allErrors:!0,allowUnionTypes:!0,$data:!0});function A(t,e,r){return void 0===r&&(r={}),y(this,void 0,void 0,(function(){var n,o;return v(this,(function(i){switch(i.label){case 0:return[4,l.default(t,{method:"POST",headers:d({Accept:"application/json","Content-Type":"application/json"},null==r?void 0:r.headers),body:JSON.stringify({query:c.jsonToGraphQLQuery({query:e})})})];case 1:return[4,(n=i.sent()).text()];case 2:o=i.sent();try{o=JSON.parse(o)}catch(e){throw new Error("Errors found in subgraphRequest: URL: "+t+", Status: "+n.status+", Response: "+o)}if(o.errors)throw new Error("Errors found in subgraphRequest: URL: "+t+", Status: "+n.status+",  Response: "+JSON.stringify(o.errors));return[2,o.data||{}]}}))}))}h.default(T),T.addFormat("address",{validate:function(t){try{return o.isAddress(t)}catch(t){return!1}}}),T.addFormat("long",{validate:function(){return!0}}),T.addFormat("ethValue",{validate:function(t){if(!t.match(/^([0-9]|[1-9][0-9]+)(\.[0-9]+)?$/))return!1;try{return i.parseUnits(t,18),!0}catch(t){return!1}}}),T.addFormat("customUrl",{type:"string",validate:function(t){return!t.length||(t.startsWith("http://")||t.startsWith("https://")||t.startsWith("ipfs://")||t.startsWith("ipns://")||t.startsWith("snapshot://"))}});var N={},x=0;t.getSnapshots=function(t,e,r,n){return y(this,void 0,void 0,(function(){var o,i,u,c,s,a,f;return v(this,(function(l){switch(l.label){case 0:return o={},n.forEach((function(t){return o[t]="latest"})),"latest"===e?[2,o]:(i=t+"-"+e+"-"+n.join("-"),u=N[i],c=Date.now(),u&&x>c?[2,u]:(x<c&&(N={},x=c+36e5-c%36e5),o[t]=e,0===(s=Object.keys(o).filter((function(e){return t!==e}))).length?[2,o]:[4,r.getBlock(e)]));case 1:return a=l.sent(),f={blocks:{__args:{where:{ts:a.timestamp,network_in:s}},network:!0,number:!0}},"https://blockfinder.snapshot.org",[4,A("https://blockfinder.snapshot.org",f)];case 2:return l.sent().blocks.forEach((function(t){return o[t.network]=t.number})),N[i]=o,[2,o]}}))}))},Object.defineProperty(t,"__esModule",{value:!0})}));
